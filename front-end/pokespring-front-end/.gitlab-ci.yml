image: node:latest
  
# This folder is cached between builds
# http://docs.gitlab.com/ce/ci/yaml/README.html#cache
cache:
  paths:
    - node_modules/

stages:
  - test
  - analyze
  - production

test_endpoints:
  stage: test
  retry: 2
  artifacts:
    paths: 
      - coverage/
  variables:
    SESSION_SECRET: 'EdKzae5Pi0IKtyXNCMwE'
    DB_HOST: 'mariadb'
    DB_DATABASE: 'otter_worlds_test'
    DB_USER: 'root'
    DB_PASSWORD: 'pasword'
    MYSQL_ROOT_PASSWORD: '$DB_PASSWORD'
  services:
    - mariadb:latest
  script:
    - npm install
    - npm run test

sonarcloud-check:
  stage: analyze
  dependencies: 
    - test_endpoints
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_HOST_URL: 'https://sonarcloud.io'
    SONAR_USER_HOME: '${CI_PROJECT_DIR}/.sonar'  # Defines the location of the analysis task cache
    GIT_DEPTH: '0'  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  only:
    - merge_requests
    - main
    - develop

production:
  type: deploy
  stage: production
  image: ruby:latest
  script:
    - echo "build launch by $GITLAB_USER_LOGIN!"
    - dpl --provider=heroku --app=$HEROKU_APP_PRODUCTION --api-key=$HEROKU_API_KEY
  only:
    - main